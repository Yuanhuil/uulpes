<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.njpes.www.dao.baseinfo.OrganizationMapper">
  <resultMap type="com.njpes.www.entity.util.Dictionary" id="distResultMap">
      <id column="id" jdbcType="VARCHAR" property="id" />
      <result column="dist" jdbcType="VARCHAR" property="name" />
  </resultMap>
  <resultMap id="BaseResultMap" type="com.njpes.www.entity.baseinfo.organization.Organization">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat May 09 20:41:44 CST 2015.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="code" jdbcType="VARCHAR" property="code" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="parent_id" jdbcType="BIGINT" property="parentId" />
    <result column="parent_ids" jdbcType="VARCHAR" property="parentIds" />
    <result column="org_type" jdbcType="CHAR" property="orgType" />
    <result column="org_level" jdbcType="INTEGER" property="orgLevel" />
    <result column="sort" jdbcType="INTEGER" property="sort" />
    <result column="isshow" jdbcType="INTEGER" property="isshow" />
    <result column="provinceid" jdbcType="VARCHAR" property="provinceid" />
    <result column="cityid" jdbcType="VARCHAR" property="cityid" />
    <result column="countyid" jdbcType="VARCHAR" property="countyid" />
    <result column="townid" jdbcType="VARCHAR" property="townid"/>
    <result column="locked" jdbcType="CHAR" property="locked"/>
    <result column="provincename" jdbcType="VARCHAR" property="provincename" />
    <result column="cityname" jdbcType="VARCHAR" property="cityname" />
    <result column="countyname" jdbcType="VARCHAR" property="countyname" />
    <result column="townname" jdbcType="VARCHAR" property="townname"/>
    <result column="imageurl" jdbcType="VARCHAR" property="imageurl"/>
    <result column="introduce" jdbcType="VARCHAR" property="introduce"/>
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat May 09 20:41:44 CST 2015.
    -->
    id, code, name, parent_id, parent_ids, org_type, org_level, sort, 
    isshow, provinceid,cityid,countyid,townid,locked,imageurl,introduce
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat May 09 20:41:44 CST 2015.
    -->
    select 
    <include refid="Base_Column_List" />
    from organization
    where id = #{id,jdbcType=BIGINT}
  </select>
  <select id="selectByName" parameterType="java.lang.String" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from organization
    where name = #{name,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat May 09 20:41:44 CST 2015.
    -->
    delete from organization
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.njpes.www.entity.baseinfo.organization.Organization"  useGeneratedKeys="true" keyProperty="id">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat May 09 20:41:44 CST 2015.
    -->
    insert into organization (id, code, name, 
      parent_id, parent_ids, org_type, 
      org_level, sort,provinceid,cityid,countyid,townid,locked,imageurl,introduce
      )
    values (#{id,jdbcType=BIGINT}, #{code,jdbcType=VARCHAR}, #{name,jdbcType=VARCHAR}, 
      #{parentId,jdbcType=BIGINT}, #{parentIds,jdbcType=VARCHAR}, #{orgType,jdbcType=CHAR}, 
      #{orgLevel,jdbcType=INTEGER}, #{sort,jdbcType=INTEGER},
      #{provinceid,jdbcType=VARCHAR},#{cityid,jdbcType=VARCHAR},
      #{countyid,jdbcType=VARCHAR},#{townid,jdbcType=VARCHAR},#{locked,jdbcType=CHAR},
      #{imageurl,jdbcType=VARCHAR},#{introduce,jdbcType=VARCHAR}
      )
  </insert>
  <insert id="insertSelective" useGeneratedKeys="true" keyProperty="id" parameterType="com.njpes.www.entity.baseinfo.organization.Organization">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat May 09 20:41:44 CST 2015.
    -->
    insert into organization
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="id != null">
        id,
      </if>
      <if test="code != null">
        code,
      </if>
      <if test="name != null">
        name,
      </if>
      <if test="parentId != null">
        parent_id,
      </if>
      <if test="parentIds != null">
        parent_ids,
      </if>
      <if test="orgType != null">
        org_type,
      </if>
      <if test="orgLevel != null">
        org_level,
      </if>
      <if test="sort != null">
        sort,
      </if>
      <if test="isshow != null">
        isshow,
      </if>
      <if test="provinceid != null">
        provinceid,
      </if>
      <if test="cityid != null">
        cityid,
      </if>
      <if test="countyid != null">
        countyid,
      </if>
      <if test="townid != null">
        townid,
      </if>
       <if test="locked != null">
        locked,
      </if>
      <if test="imageurl != null">
        imageurl,
      </if>
      <if test="introduce != null">
        introduce,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="id != null">
        #{id,jdbcType=BIGINT},
      </if>
      <if test="code != null">
        #{code,jdbcType=VARCHAR},
      </if>
      <if test="name != null">
        #{name,jdbcType=VARCHAR},
      </if>
      <if test="parentId != null">
        #{parentId,jdbcType=BIGINT},
      </if>
      <if test="parentIds != null">
        #{parentIds,jdbcType=VARCHAR},
      </if>
      <if test="orgType != null">
        #{orgType,jdbcType=CHAR},
      </if>
      <if test="orgLevel != null">
        #{orgLevel,jdbcType=INTEGER},
      </if>
      <if test="sort != null">
        #{sort,jdbcType=INTEGER},
      </if>
      <if test="isshow != null">
        #{isshow,jdbcType=INTEGER},
      </if>
      <if test="provinceid != null">
        #{provinceid,jdbcType=VARCHAR},
      </if>
      <if test="cityid != null">
        #{cityid,jdbcType=VARCHAR},
      </if>
      <if test="countyid != null">
        #{countyid,jdbcType=VARCHAR},
      </if>
       <if test="townid != null">
        #{townid,jdbcType=VARCHAR},
      </if>
      <if test="locked != null">
      	#{locked,jdbcType=CHAR},
      </if>
      <if test="imageurl != null">
      	#{imageurl,jdbcType=VARCHAR},
      </if>
      <if test="introduce != null">
      	#{introduce,jdbcType=VARCHAR}
      </if>
    </trim>
  </insert>
  <!-- 批量插入 -->
  <insert id="insertBatch" useGeneratedKeys="true" parameterType="java.util.List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Mar 21 22:47:33 CST 2015.
    -->
    <selectKey resultType="long" keyProperty="id" order="AFTER">  
        SELECT  
        LAST_INSERT_ID()  
    </selectKey>  
    insert into organization ( code, name, 
      parent_id, parent_ids, org_type, isshow, 
      org_level, sort,provinceid,cityid,countyid,townid,locked,imageurl,introduce
      )
    values 
    <foreach collection="list" item="item" index="index" separator="," >  
    	(#{item.code,jdbcType=VARCHAR}, #{item.name,jdbcType=VARCHAR}, 
      #{item.parentId,jdbcType=BIGINT}, #{item.parentIds,jdbcType=VARCHAR}, #{item.orgType,jdbcType=CHAR}, 
      #{item.isshow,jdbcType=CHAR}, #{item.orgLevel,jdbcType=INTEGER}, #{item.sort,jdbcType=INTEGER},
      #{item.provinceid,jdbcType=VARCHAR},#{item.cityid,jdbcType=VARCHAR},#{item.countyid,jdbcType=VARCHAR},
      #{item.townid,jdbcType=VARCHAR},#{item.locked,jdbcType=CHAR},#{item.imageurl,jdbcType=VARCHAR},
      #{item.introduce,jdbcType=VARCHAR}
      )
    </foreach>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.njpes.www.entity.baseinfo.organization.Organization">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat May 09 20:41:44 CST 2015.
    -->
    update organization
    <set>
      <if test="code != null">
        code = #{code,jdbcType=VARCHAR},
      </if>
      <if test="name != null">
        name = #{name,jdbcType=VARCHAR},
      </if>
      <if test="parentId != null">
        parent_id = #{parentId,jdbcType=BIGINT},
      </if>
      <if test="parentIds != null">
        parent_ids = #{parentIds,jdbcType=VARCHAR},
      </if>
      <if test="orgType != null">
        org_type = #{orgType,jdbcType=CHAR},
      </if>
      <if test="orgLevel != null">
        org_level = #{orgLevel,jdbcType=INTEGER},
      </if>
      <if test="sort != null">
        sort = #{sort,jdbcType=INTEGER},
      </if>
      <if test="isshow != null">
        isshow = #{isshow,jdbcType=INTEGER},
      </if>
      <if test="provinceid != null">
        provinceid = #{provinceid,jdbcType=VARCHAR},
      </if>
      <if test="cityid != null">
        cityid = #{cityid,jdbcType=VARCHAR},
      </if>
      <if test="countyid != null">
        countyid = #{countyid,jdbcType=VARCHAR},
      </if>
      <if test="townid != null">
        townid = #{townid,jdbcType=VARCHAR},
      </if>
      <if test="locked != null">
      	locked = #{locked,jdbcType=CHAR},
      </if>
      <if test="imageurl != null">
      	imageurl = #{imageurl,jdbcType=VARCHAR},
      </if>
      <if test="introduce != null">
      	introduce = #{introduce,jdbcType=VARCHAR},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.njpes.www.entity.baseinfo.organization.Organization">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat May 09 20:41:44 CST 2015.
    -->
    update organization
    set code = #{code,jdbcType=VARCHAR},
      name = #{name,jdbcType=VARCHAR},
      parent_id = #{parentId,jdbcType=BIGINT},
      parent_ids = #{parentIds,jdbcType=VARCHAR},
      org_type = #{orgType,jdbcType=CHAR},
      org_level = #{orgLevel,jdbcType=INTEGER},
      sort = #{sort,jdbcType=INTEGER},
      isshow = #{isshow,jdbcType=INTEGER},
      provinceid = #{provinceid,jdbcType=VARCHAR},
      cityid = #{cityid,jdbcType=VARCHAR},
      countyid = #{countyid,jdbcType=VARCHAR},
      townid = #{townid,jdbcType=VARCHAR},
      locked = #{locked,jdbcType=CHAR},
      imageurl = #{imageurl,jdbcType=VARCHAR},
      introduce = #{introduce,jdbcType=VARCHAR}
    where id = #{id,jdbcType=BIGINT}
  </update>
  <!-- 批量更新 -->
  <update id="updateBatch" parameterType="java.util.List">
    <foreach collection="list" item="item" open="" close="" separator=";" >  
    update organization 
    <set> 
      code = #{item.code,jdbcType=VARCHAR},
      name = #{item.name,jdbcType=VARCHAR},
      parent_id = #{item.parentId,jdbcType=BIGINT},
      parent_ids = #{item.parentIds,jdbcType=VARCHAR},
      org_type = #{item.orgType,jdbcType=CHAR},
      org_level = #{item.orgLevel,jdbcType=INTEGER},
      sort = #{item.sort,jdbcType=INTEGER},
      isshow = #{item.isshow,jdbcType=INTEGER},
      provinceid = #{item.provinceid,jdbcType=VARCHAR},
      cityid = #{item.cityid,jdbcType=VARCHAR},
      countyid = #{item.countyid,jdbcType=VARCHAR},
      townid = #{item.townid,jdbcType=VARCHAR},
      locked = #{item.locked,jdbcType=CHAR},
      imageurl = #{item.imageurl,jdbcType=VARCHAR},
      introduce = #{item.introduce,jdbcType=VARCHAR}
    </set> 
    <where>  
         code = #{item.code,jdbcType=BIGINT}
       </where>    
    </foreach>  
  </update>
	<!-- 可能需要根据用户的类型角色进行过滤 预留 -->
	<select id="selectAllOrganizations" resultMap="BaseResultMap">
		select <include refid="Base_Column_List" /> from organization
	</select>

	<select id="selectSubOrgsByWebQueryPage" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from organization
		<where>
			<if test="org.name != null and org.name !=''">
				and name like CONCAT('%',#{org.name,jdbcType=VARCHAR},'%' ) 
			</if>
			<if test="org.orgType != null and org.orgType !=''">
				and org_type = #{org.orgType,jdbcType=CHAR}
			</if>
			<if test="org.orgLevel != null and org.orgLevel !=''">
				and org_level = #{org.orgLevel,jdbcType=INTEGER}
			</if>
			<if test="org.provinceid != null and org.provinceid !=''">
				and provinceid = #{org.provinceid,jdbcType=VARCHAR}
			</if>
			<if test="org.cityid != null and org.cityid !=''">
				and cityid = #{org.cityid,jdbcType=VARCHAR}
			</if>
			<if test="org.countyid != null and org.countyid !=''">
				and countyid = #{org.countyid,jdbcType=VARCHAR}
			</if>
			<if test="org.townid != null and org.townid !=''">
				and townid = #{org.townid,jdbcType=VARCHAR}
			</if>
			<if test="org.parentId !=null and org.parentId !=''">
				and parent_id = #{org.parentId,jdbcType=BIGINT}
			</if>
		</where>
	</select>
	<select id="selectSubOrgsByOrgidPage" resultMap="BaseResultMap">
		select 
		<include refid="Base_Column_List" />
		from organization
		where
		parent_ids like CONCAT((select CONCAT(parent_ids , id) from organization where id=#{orgid,jdbcType=BIGINT}),'%')
	</select>
	<select id="selectSubOrgsByType" resultMap="BaseResultMap">
		select 
		<include refid="Base_Column_List" />
		from organization
		where
		parent_ids like CONCAT((select CONCAT(parent_ids , id) from organization where id=#{orgid,jdbcType=BIGINT}
		<if test="orgtype != null and  orgtype !=''">
			and org_type = #{orgtype,jdbcType=CHAR}
		</if>
		),'%')
	</select>
	<select id="selectSonSubOrgsByType" resultMap="BaseResultMap">
	select 
		<include refid="Base_Column_List" />
		from organization
		<where>
		<if test="orgtype != null and  orgtype !=''">
			and org_type = #{orgtype,jdbcType=CHAR}
		</if>
		<if test="orgid !=null and orgid >0">
			and parent_id = #{orgid,jdbcType=BIGINT}
		</if>
		</where>
	</select>
	
	<select id="getQuxianAndSchoolsOrgs" resultMap="BaseResultMap">
	select 
		<include refid="Base_Column_List" />
		from organization
		<where>
		<if test="orgid !=null and orgid >0">
			 (parent_id = #{orgid,jdbcType=BIGINT} and org_type=1) or (org_type=2 and org_level=6)
		</if>
		</where>
	</select>
	<select id="findParent" resultMap="BaseResultMap">
	select <include refid="Base_Column_List" />
	 from organization where id=(
	 select parent_id from organization where id=#{orgid,jdbcType=BIGINT}
	 )
	</select>	
	<select id="getEduOrganizationByCountyId" resultMap="BaseResultMap">
	    select 
		<include refid="Base_Column_List" />
		from organization
		where org_level=4 and countyid = #{areaid} and org_type=1
	</select>
	<select id="getEduOrganizationByCityId" resultMap="BaseResultMap">
	    select 
		<include refid="Base_Column_List" />
		from organization
		where org_level=4 and cityid = #{areaid} and org_type=1
	</select>
	<select id="getSchoolOrgByTownId" resultMap="BaseResultMap">
	    select 
		<include refid="Base_Column_List" />
		from organization
		where org_level=6 and townid = #{areaid} and org_type=2
	</select>
	<select id="getSchoolOrgByCountyIds"  resultMap="BaseResultMap">
	    select 
	    <include refid="Base_Column_List" /> 
	    from organization where org_type='2' and org_level=6 and countyid in 
	    	<foreach collection="list" item="item" index="index" open="(" separator="," close=")">
  				#{item}
  			</foreach>
	</select>
		<select id="getSchoolOrgByTownIds"  resultMap="BaseResultMap">
	    select 
	    <include refid="Base_Column_List" /> 
	    from organization where org_type='2' and org_level=6 and townid in 
	    	<foreach collection="list" item="item" index="index" open="(" separator="," close=")">
  				#{item}
  			</foreach>
	</select>
	<select id="getSchoolOrgByCityIds"  resultMap="BaseResultMap">
	    select 
	    <include refid="Base_Column_List" /> 
	    from organization where org_type='2' and org_level &lt; 6 and countyid in(#{cityids})
	</select>
	<select id="getOrgByCode"  parameterType="java.lang.String" resultMap="BaseResultMap">
	    select 
	    <include refid="Base_Column_List" /> 
	    from organization where code=#{code}
	</select>
	<!-- 根据组织机构层级选择行政区划 -->
	<select id="getDistsByOrgLevel" parameterType="int" resultMap="distResultMap">
	    select area.guojiacode as id,
		CASE WHEN org.countyid is not null THEN area.qu
		WHEN org.townid is not null THEN area.xianqu
		WHEN org.cityid is not null THEN area.dishi
		END  as dist
		from organization org 
		join area on 
		CASE WHEN org.countyid is not null THEN org.countyid=area.guojiacode 
		WHEN org.townid is not null THEN org.townid=area.guojiacode 
		WHEN org.cityid is not null THEN org.cityid=area.guojiacode
		END
		where org.org_level=#{orgLevel}
	 </select>
	 
	 <select id="getSchoolOrgByCityId" parameterType="java.lang.String" resultType="com.njpes.www.entity.baseinfo.organization.Organization">
	 	SELECT id,name FROM organization where cityid=#{cityid} and org_type='2' 
	 </select>
	 
	 <select id="getSchoolOrgByCountyId" parameterType="java.lang.String" resultType="com.njpes.www.entity.baseinfo.organization.Organization">
	 	SELECT id,name FROM organization where countyid=#{countyid} and org_type='2' 
	 </select>
	 
	 <select id="getCountiesByCity" parameterType="java.lang.String" resultType="com.njpes.www.entity.baseinfo.organization.Organization">
	 	SELECT org.countyid id, na.name FROM organization org join newarea na on org.countyid=na.code
		where org.cityid=#{cityid} and org_type='2' and na.level=3 group by org.countyid, na.name
	 </select>
	 
	 <select id="getTownsByCounty" parameterType="java.lang.String" resultType="com.njpes.www.entity.baseinfo.organization.Organization">
	 	SELECT org.townid id, na.name FROM organization org join newarea na on org.townid=na.code
		where org.countyid=#{countyid} and org_type='2'  and na.level=4 group by org.townid, na.name
	 </select>
  	<update id="updateLocked">
  		update organization set locked = #{locked,jdbcType=CHAR} where id=#{orgid,jdbcType=BIGINT}
  	</update>
  	<select id="getMaxId" resultType="java.lang.Long">
  		select max(id) from organization
  	</select>
  	<select id="selectSonSubOrgsByOrgLevel" resultMap="BaseResultMap">
  	select 
		<include refid="Base_Column_List" />
		from organization
		<where>
		<if test="orglevel != null and  orglevel >0">
			and org_level = #{orglevel,jdbcType=CHAR}
		</if>
		<if test="orgid !=null and orgid >0">
			and parent_id = #{orgid,jdbcType=BIGINT}
		</if>
		and org_type ='1'
		</where>
  	</select>
  	<select id="selectAllSchools" resultMap="BaseResultMap">
  	select 
  	<include refid="Base_Column_List" />
		from organization
		where org_type = '2' order by id
  	</select>
  	<select id="selectAllEcs" resultMap="BaseResultMap">
  	select 
  	<include refid="Base_Column_List" />
		from organization
		where org_type = '1' and id != 1 order by id
  	</select>
</mapper>