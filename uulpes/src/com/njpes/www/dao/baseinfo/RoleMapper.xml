<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.njpes.www.dao.baseinfo.RoleMapper" >
  <resultMap id="BaseResultMap" type="com.njpes.www.entity.baseinfo.Role" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Mar 21 22:53:17 CST 2015.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="role_name" property="roleName" jdbcType="VARCHAR" />
    <result column="role" property="role" jdbcType="VARCHAR" />
    <result column="org_level" property="org_level" jdbcType="BIGINT" />
    <result column="role_desc" property="roleDesc" jdbcType="VARCHAR" />
    <result column="is_show" property="isShow" jdbcType="CHAR" />
    <result column="role_org" property="roleOrg" jdbcType="CHAR"/>
    <result column="role_level" property="role_level" jdbcType="BIGINT"/>
    <result column="isadmin" property="isadmin" jdbcType="CHAR" />
    <result column="system_level" property="systemlevel" jdbcType="CHAR"/>
    <result column="roletypeflag" property="roletypeflag" jdbcType="CHAR"/>
    <collection property="resourcePermissions" ofType="com.njpes.www.entity.baseinfo.RoleResourcePermission">
    	<id     column="rrp_id" property="id" jdbcType="BIGINT"/>
    	<result column="role_id" property="roleId" jdbcType="BIGINT" />
  		<result column="res_id" property="resId" jdbcType="BIGINT" />
    	<result column="perm_ids" property="permIds" jdbcType="VARCHAR" />
    	<association property="resource" javaType="com.njpes.www.entity.baseinfo.Resource" >
    		<id column="rest_id" property="id" jdbcType="BIGINT" />
    		<result column="res_name" property="resName" jdbcType="VARCHAR" />
    		<result column="res_key" property="resKey" jdbcType="VARCHAR" />
    		<result column="res_url" property="resUrl" jdbcType="VARCHAR" />
    		<result column="parent_id" property="parentId" jdbcType="BIGINT" />
    		<result column="parent_ids" property="parentIds" jdbcType="VARCHAR" />
    		<result column="res_sort" property="resSort" jdbcType="INTEGER" />
    		<result column="res_is_show" property="isShow" jdbcType="CHAR" />
   	 		<result column="icon" property="icon" jdbcType="VARCHAR" />
    		<result column="actualreskey" property="actualreskey" jdbcType="VARCHAR"/>	
    	</association>
    </collection>
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Mar 21 22:53:17 CST 2015.
    -->
    id, role_name, role, role_desc,org_level, is_show,role_org,role_level,isadmin,system_level,roletypeflag
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Mar 21 22:53:17 CST 2015.
    -->
    select 
  r.id, role_name, role, role_desc, r.is_show,r.org_level, role_org,r.role_level,r.isadmin,system_level,roletypeflag,
  rrp.id as rrp_id,rrp.res_id,rrp.perm_ids,rrp.role_id,
  res.id as rest_id, res.res_name, res.res_key, res.res_url, res.parent_id, 
  res.parent_ids, res.res_sort, res.icon,res.is_show as res_is_show,res.actualreskey
  	 from role r 
     left join role_res_perm rrp on r.id = rrp.role_id
     left join resource res on rrp.res_id=res.id
    where r.id = #{id,jdbcType=BIGINT}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Mar 21 22:53:17 CST 2015.
    -->
    delete from role
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.njpes.www.entity.baseinfo.Role" useGeneratedKeys="true" keyProperty="id">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Mar 21 22:53:17 CST 2015.
    -->
    insert into role (role_name, role, 
      role_desc, is_show,org_level,role_level,role_org,isadmin,roletypeflag)
    values (#{roleName,jdbcType=VARCHAR}, #{role,jdbcType=VARCHAR}, 
      #{roleDesc,jdbcType=VARCHAR}, #{isShow,jdbcType=CHAR},#{org_level},#{role_level},#{roleOrg},#{isadmin},#{roletypeflag})
  </insert>
  <insert id="insertSelective" parameterType="com.njpes.www.entity.baseinfo.Role" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Mar 21 22:53:17 CST 2015.
    -->
    insert into role
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="roleName != null" >
        role_name,
      </if>
      <if test="role != null" >
        role,
      </if>
      <if test="roleDesc != null" >
        role_desc,
      </if>
      <if test="isShow != null" >
        is_show,
      </if>
      <if test="org_level != null" >
        org_level,
      </if>
      <if test="role_level != null" >
        role_level,
      </if>
      <if test="roleOrg != null" >
        role_org,
      </if>
      <if test="isadmin != null" >
        isadmin,
      </if>
       <if test="roletypeflag != null" >
        roletypeflag,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=BIGINT},
      </if>
      <if test="roleName != null" >
        #{roleName,jdbcType=VARCHAR},
      </if>
      <if test="role != null" >
        #{role,jdbcType=VARCHAR},
      </if>
      <if test="roleDesc != null" >
        #{roleDesc,jdbcType=VARCHAR},
      </if>
      <if test="isShow != null" >
        #{isShow,jdbcType=CHAR},
      </if>
      <if test="org_level != null" >
        #{org_level,jdbcType=BIGINT},
      </if>
      <if test="role_level != null" >
        #{role_level,jdbcType=BIGINT},
      </if>
       <if test="roleOrg != null" >
        #{roleOrg,jdbcType=CHAR},
      </if>
       <if test="isadmin != null" >
        #{isadmin,jdbcType=CHAR},
      </if>
       <if test="roletypeflag != null" >
        #{roletypeflag,jdbcType=CHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.njpes.www.entity.baseinfo.Role" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Mar 21 22:53:17 CST 2015.
    -->
    update role
    <set >
      <if test="roleName != null" >
        role_name = #{roleName,jdbcType=VARCHAR},
      </if>
      <if test="role != null" >
        role = #{role,jdbcType=VARCHAR},
      </if>
      <if test="roleDesc != null" >
        role_desc = #{roleDesc,jdbcType=VARCHAR},
      </if>
      <if test="isShow != null" >
        is_show = #{isShow,jdbcType=CHAR},
      </if>
      <if test="org_level != null" >
        org_level = #{org_level,jdbcType=BIGINT},
      </if>
      <if test="role_level != null" >
        role_level = #{role_level,jdbcType=BIGINT},
      </if>
      <if test="roleOrg != null" >
        role_org = #{roleOrg,jdbcType=CHAR},
      </if>
      <if test="isadmin != null" >
       isadmin =  #{isadmin,jdbcType=CHAR},
      </if>
      <if test="roletypeflag != null" >
       roletypeflag =  #{roletypeflag,jdbcType=CHAR},
      </if>
    </set>
    where id = #{id,jdbcType=BIGINT}
  </update>
  
  <select id="selectAllByPage" resultMap="BaseResultMap">
  select 
  t.id, role_name, role, role_desc, is_show,role_org,isadmin,system_level,roletypeflag,
  p.id as rrp_id,p.res_id,p.perm_ids,p.role_id,
  res_name, res_key, res_url, parent_id, parent_ids, res_sort, icon,actualreskey
  from role t 
  left join role_res_perm p on t.id=p.role_id
  left join resource res on p.res_id=res.id
  </select>
  
  <select id="selectBySelective" parameterType="com.njpes.www.entity.baseinfo.Role" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from role
		<where>
			<if test="roleName != null and roleName!=''" >
			  and role_name = #{roleName,jdbcType=VARCHAR}
			</if>
			<if test="role != null and role !=''" >
			  and role = #{role,jdbcType=VARCHAR}
			</if>
			<if test="roleDesc != null and roleDesc !=''" >
			  and role_desc = #{roleDesc,jdbcType=VARCHAR}
			</if>
			<if test="isShow != null and isShow !=''" >
			  and is_show = #{isShow,jdbcType=CHAR}
			</if>
			<if test="org_level != null and org_level != 0" >
			  and org_level = #{org_level,jdbcType=BIGINT}
			</if>
			<if test="role_level != null and role_level != 0" >
			  and role_level = #{role_level,jdbcType=BIGINT}
			</if>
			<if test="roleOrg != null and roleOrg == ''" >
			  and role_org = #{roleOrg,jdbcType=CHAR}
			</if>
		</where>
		order by id
  </select>
  
  <select id="selectAll" resultMap="BaseResultMap">
  	select <include refid="Base_Column_List" /> from role
  </select>
  <!-- 史斌增加根据当前用户组织机构和角色级别获取所有的角色 --> 
<select id="selectRolesByOrgAndLevel" resultMap="BaseResultMap">
  	select 
	  t.id, role_name, role, role_desc, is_show,org_level,isadmin,system_level,roletypeflag,
	  p.id as rrp_id,p.res_id,p.perm_ids,p.role_id
	  from role t left join role_res_perm p on t.id=p.role_id 
	  where t.id in(
	  select
	   * from (select 
	  tt.id from role tt left join role_res_perm tp on tt.id=tp.role_id 
	  join auth au on tt.id = au.role_id where au.org_id=#{orgid, jdbcType=INTEGER} and tt.role_level>=#{rolelevel, jdbcType=INTEGER}
	  group by tt.id limit #{page.start,jdbcType=INTEGER},#{page.end,jdbcType=INTEGER}) x
	  )
  </select>
  <select id="selectAllByRoleIds" resultMap="BaseResultMap">
  	select  t.id, role_name, role, role_desc, is_show,isadmin,system_level,roletypeflag,
  p.id as rrp_id,p.res_id,p.perm_ids,p.role_id,res.id as rest_id, res.res_name, 
  res.res_key, res.res_url, res.parent_id, 
  res.parent_ids, res.res_sort, res.icon,res.is_show as res_is_show,res.actualreskey
  from role t 
  left join role_res_perm p on t.id=p.role_id
  left join resource res on p.res_id=res.id 
  	<where>
  		<if test="roleIds != null and roleIds.size() > 0">
  			t.id in 
  			<foreach collection="roleIds" item="item" index="index" open="(" separator="," close=")">
  			#{item}
  			</foreach>
  		</if>
  	</where>
  </select>    
  <select id="getTeacherRoles" parameterType="long" resultMap="BaseResultMap">
      select distinct(ro.id), ro.role_name from auth au 
		join account ac on au.user_id=ac.id
		join role ro on au.role_id=ro.id
		where au.org_id=#{orgid} and ac.type_flag=2
  </select>
  <select id="getTeacherRolesByOrglevel" parameterType="long" resultMap="BaseResultMap">
       select ro.id, ro.role_name from role ro 
		where ro.roletypeflag=2
		<if test="orglevel==6">
		    and ro.role_level=6 
		</if>
		<if test="orglevel==4">
		    and ro.role!=67
		</if>
  </select>
  <select id="getEduTeacherRoles" parameterType="long" resultMap="BaseResultMap">
      select distinct(ro.role_name) from account ac
		join user_org_job uo on ac.id = uo.user_id
		join organization org on uo.org_id=org.id
		join organization org1 on org.parent_ids like CONCAT(org1.parent_ids,'%')
		join auth au on au.user_id=ac.id
		join role ro on au.role_id=ro.id
		where org1.id=#{orgid}
  </select>
  <delete id="deleteByPrimaryKeys">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Mar 21 22:53:17 CST 2015.
    -->
    delete from role
    where id in 
    <foreach item="item" index="index" collection="list"
			open="(" separator="," close=")">
			#{item}
	</foreach>
  </delete>
  
  <select id="selectAllRole" resultType="int">
  	select  count(id) from role
  </select>
  
  <select id="selectEntityMapPage" resultMap="BaseResultMap">
  	select  t.id, role_name, role, role_desc,org_level, is_show,isadmin,system_level,roletypeflag from role t
  	<where>
  		<if test="role.org_level > 0">
  			org_level=#{role.org_level,jdbcType=BIGINT}
  		</if>
  		<if test="role.id > 0">
  			and id=#{role.id,jdbcType=BIGINT}
  		</if>
  	</where>
  </select>
  <select id="selectRolesByUserId" resultMap="BaseResultMap">
  	select 
  r.id, role_name, role, role_desc, r.is_show,r.org_level, role_org,r.role_level,r.isadmin,r.system_level,roletypeflag,
  rrp.id as rrp_id,rrp.res_id,rrp.perm_ids,rrp.role_id,
  res.id as rest_id, res.res_name, res.res_key, res.res_url, res.parent_id, 
  res.parent_ids, res.res_sort, res.icon,res.is_show as res_is_show,res.actualreskey
  	 from auth t 
  	 left join organization o on t.org_id = o.id
     left join account a on t.user_id=a.id
     left join role r on t.role_id=r.id
     left join role_res_perm rrp on t.role_id = rrp.role_id
     left join resource res on rrp.res_id=res.id
      where t.user_id = #{userId,jdbcType=BIGINT}
     <choose>
		<when test="logintype == 1">
			and (o.org_type = '1' or o.org_type = '2')
		</when>
		<otherwise>
			and o.org_type = #{logintype,jdbcType=VARCHAR}
		</otherwise>
	</choose>
  </select>
 	
  <select id="getSubordinateRoles" resultMap="BaseResultMap">
  	select * from role where role_level
  	&gt;=
  	(select role_level from role where id=#{roleId})
  </select>
  <select id="selectRolesByRoleLevel" resultMap="BaseResultMap">
  	select * from role 
  	<where>
  		<if test="rolelevel != null and rolelevel > 0">
  			<if test="orgType == 2">
  				and role_level >= #{rolelevel,jdbcType=BIGINT}
  			</if>
  			<if test="orgType != 2">
  				and role_level > #{rolelevel,jdbcType=BIGINT}
  			</if>
  			<if test="rolelevel == 4">
  				and role_level > #{rolelevel,jdbcType=BIGINT} and isadmin='1'
  			</if>
  			
  		</if>
  		
  		<choose>
		<when test="orgType == 3">
			and role_org = '3' 
		</when>
		<when test="orgType == 2">
			and role_org = '2'
		</when>
		<otherwise>
			and role_org = '1' 
		</otherwise>
	</choose>
  	</where>
  	and id &lt;&gt;39 and id &lt;&gt;44
  </select>
  <select id="selectRolesByOrgLevel" resultMap="BaseResultMap">
  	select * from role 
  	<where>
  		<if test="orglevel != null and orglevel > 0">
  			and org_level = #{orglevel,jdbcType=BIGINT}
  		</if>
  		<if test="isadmin == true">
  			and isadmin = 1
  		</if>
  		<if test='orgType != null and orgType!=""'>
  		    and role_org = #{orgType}
  		</if>
  		<!-- <choose>
		<when test='orgType == "3"'> 
			and role_org = '3' 
		</when>
		<otherwise>
			and role_org = '1' 
		</otherwise>
	</choose>-->
  	</where>
  	and id &lt;&gt;39 and id &lt;&gt;44
  </select>
  <select id="selectRolesByRoleAndOrgLevelIncludeSonAdmin" resultMap="BaseResultMap">
  select * from role 
  	<where>
  		<if test="rolelevel != null and rolelevel > 0">
  			and role_level = #{rolelevel,jdbcType=BIGINT}
  		</if>
  		<choose>
		<when test="orgType == 3">
			and role_org = '3' 
		</when>
		<otherwise>
			and role_org = '1' 
		</otherwise>
		</choose>
		or
		<if test="rolelevel != null and orglevel > 0 and orglevel >0">
  			(role_level=#{rolelevel,jdbcType=BIGINT}  +1
  			and isadmin=1  and org_level=#{orglevel,jdbcType=BIGINT} +1
  		</if>
  		<choose>
		<when test="orgType == 3">
			and role_org = '3' 
		</when>
		<otherwise>
			and role_org = '1' 
		</otherwise>
		</choose>
		<![CDATA[ 
        )
        ]]>  
  	</where>
  	and id &lt;&gt;39 and id &lt;&gt;44
  </select>
  <select id="selectTeacherAdmin" resultMap="BaseResultMap">
    select * from role  where 
    <if test="type == 1">
        id=67
    </if>
    <if test="type == 2">
        id=20
    </if>
    <if test="type == 3">
        id=20 or id=67
    </if>
  </select>
  <select id="selectRolesByOrgLevelAndRoleLevel"  resultMap="BaseResultMap">
      select * from role where
      org_level=#{orglevel} and role_level=#{rolelevel} and role_org=#{orgtype}
  </select>
</mapper>